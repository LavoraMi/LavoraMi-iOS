name: Xcode Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Detect Xcode project or workspace and scheme
      id: detect
      run: |
        set -e
        # Look for workspace first
        if [ -d "LavoraMi.xcodeproj/project.xcworkspace" ]; then
          WORKSPACE="LavoraMi.xcodeproj/project.xcworkspace"
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
          SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list -json 2>/dev/null | jq -r '.schemes[0]' 2>/dev/null)
          if [ -z "$SCHEME" ] || [ "$SCHEME" = "null" ]; then
            SCHEME="LavoraMi"
          fi
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
        elif ls *.xcworkspace 1> /dev/null 2>&1; then
          WORKSPACE=$(ls -d *.xcworkspace 2>/dev/null | head -n1)
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
          SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list -json 2>/dev/null | jq -r '.schemes[0]' 2>/dev/null)
          if [ -z "$SCHEME" ] || [ "$SCHEME" = "null" ]; then
            SCHEME="LavoraMi"
          fi
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
        elif ls *.xcodeproj 1> /dev/null 2>&1; then
          PROJECT=$(ls -d *.xcodeproj 2>/dev/null | head -n1)
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          SCHEME=$(xcodebuild -project "$PROJECT" -list -json 2>/dev/null | jq -r '.schemes[0]' 2>/dev/null)
          if [ -z "$SCHEME" ] || [ "$SCHEME" = "null" ]; then
            SCHEME="LavoraMi"
          fi
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
        else
          echo "No Xcode project (.xcodeproj) or workspace (.xcworkspace) found in repository." >&2
          exit 1
        fi

    - name: Build
      run: |
        set -e
        DEST='platform=iOS Simulator,name=iPhone 16'
        if [ -n "${{ steps.detect.outputs.workspace }}" ]; then
          echo "Building workspace ${{ steps.detect.outputs.workspace }} scheme ${{ steps.detect.outputs.scheme }}"
          xcodebuild clean build -workspace "${{ steps.detect.outputs.workspace }}" -scheme "${{ steps.detect.outputs.scheme }}" -sdk iphonesimulator -destination "$DEST" ONLY_ACTIVE_ARCH=NO
        else
          echo "Building project ${{ steps.detect.outputs.project }} scheme ${{ steps.detect.outputs.scheme }}"
          xcodebuild clean build -project "${{ steps.detect.outputs.project }}" -scheme "${{ steps.detect.outputs.scheme }}" -sdk iphonesimulator -destination "$DEST" ONLY_ACTIVE_ARCH=NO
        fi

    - name: Run tests
      run: |
        set -e
        DEST='platform=iOS Simulator,name=iPhone 16'
        if [ -n "${{ steps.detect.outputs.workspace }}" ]; then
          xcodebuild test -workspace "${{ steps.detect.outputs.workspace }}" -scheme "${{ steps.detect.outputs.scheme }}" -destination "$DEST"
        else
          xcodebuild test -project "${{ steps.detect.outputs.project }}" -scheme "${{ steps.detect.outputs.scheme }}" -destination "$DEST"
        fi

    - name: Upload test results (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: xcode-test-logs
        path: DerivedData/
